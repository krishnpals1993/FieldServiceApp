@model FieldServiceApp.Models.DashboardViewModel
@using Microsoft.AspNetCore.Http
@using  Newtonsoft.Json;
@inject IHttpContextAccessor HttpContextAccessor
@{

    String RoleName = Convert.ToString(@HttpContextAccessor.HttpContext.Session.GetString("RoleName"));
    ViewData["Title"] = "Dashboard";
}

<div class="page-content container container-plus" id="calendar-page">
    <!-- page header -->
    <div class="d-lg-none page-header border-0 py-0">
        <h1 class="text-dark-m3 pb-0 mb-0 text-125">
            Dashboard
        </h1>

        <!-- page tools -->
        <div class="page-tools d-none">
            <div class="action-buttons text-nowrap">
                <a class="btn bgc-white btn-light-secondary mx-0" href="#" data-toggle="tooltip" title="Details">
                    <i class="fa fa-search-plus text-blue"></i>
                </a>
                <a class="btn bgc-white btn-light-secondary mx-0" href="#" data-toggle="tooltip" title="Print">
                    <i class="fa fa-print text-purple"></i>
                </a>
                <a class="btn bgc-white btn-light-secondary mx-0" href="#" data-toggle="tooltip" title="Remove">
                    <i class="fa fa-trash-alt text-danger"></i>
                </a>
            </div>
        </div>
    </div>

    @if (RoleName == "Admin")
    {
        <div class="row px-2 mt-3">
            <div class="col-12 col-sm-6 col-lg-3 px-2 mb-2 mb-lg-0">
                <div class="bcard h-100 d-flex align-items-center p-3">
                    <div>
                        <span class="d-inline-block bgc-green-d1 p-3 radius-round text-center border-4 brc-green-l2">
                            <i class="fa fa-dollar-sign text-white text-180 w-4 h-4"></i>
                        </span>
                    </div>

                    <div class="ml-3">
                        <div class="pos-rel">
                            <span class="text-dark-tp4 text-140">$</span>
                            <span class="text-dark-tp3 text-180">85k</span>

                            <span class="text-blue-m1 text-600 text-90 ml-2 text-nowrap">
                                8%
                                <i class="fa fa-arrow-up"></i>
                            </span>
                        </div>
                        <div class="text-dark-tp4">today's earnings</div>
                    </div>

                    <div class="position-tr m-1">
                        <!-- the dropdown used in some boxes (cards) -->
                        <div class="dropdown dd-backdrop dd-backdrop-none-md">
                            <button type="button" class="btn btn-sm btn-text-pale btn-brc-tp btn-outline-lightgrey btn-h-light-default btn-a-light-default dropdown-toggle" data-toggle="dropdown" data-display="static" aria-haspopup="true" aria-expanded="false">
                                <i class="fa fa-ellipsis-h"></i>
                            </button>

                            <div class="dropdown-menu p-3px mw-auto shadow-sm dropdown-menu-right dropdown-caret dropdown-animated dd-appear-center dd-slide-none-md radius-1 brc-secondary-l1">
                                <div class="dropdown-inner">
                                    <a class="dropdown-item btn btn-light-grey btn-h-lighter-default btn-a-lighter-primary btn-bgc-tp px-3" href="#">
                                        <i class="fa fa-cog text-blue mr-1"></i>
                                        Some action
                                    </a>

                                    <a class="dropdown-item btn btn-light-grey btn-h-lighter-default btn-a-lighter-primary btn-bgc-tp px-3" href="#">
                                        <i class="fas fa-tools text-blue mr-1"></i>
                                        Another action
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <div class="col-12 col-sm-6 col-lg-3 px-2 mb-2 mb-lg-0">
                <div class="bcard h-100 d-flex align-items-center p-3">

                    <div>
                        <span class="d-inline-block bgc-warning-d1 p-3 radius-round text-center border-4 brc-warning-l2">
                            <i class="fa fa-shopping-cart text-white text-170 w-4 h-4"></i>
                        </span>
                    </div>

                    <div class="ml-3">
                        <div class="pos-rel">
                            <span class="text-dark-tp3 text-180">369</span>
                            <span class="text-danger-m2 text-600 text-90 ml-2 text-nowrap">
                                2%
                                <i class="fa fa-arrow-down"></i>
                            </span>
                        </div>
                        <div class="text-dark-tp4 text-110">new orders</div>
                    </div>

                    <!-- this is a dropdown with tooltips -->
                    <div class="position-tr m-1 dropdown dd-backdrop dd-backdrop-none-md">
                        <button type="button" class="btn btn-sm btn-brc-tp btn-bgc-tp btn-text-pale btn-light-default dropdown-toggle" data-toggle="dropdown" data-display="static" aria-haspopup="true" aria-expanded="false">
                            <i class="fa fa-ellipsis-h"></i>
                        </button>

                        <div class="dropdown-menu p-3px mw-auto shadow-sm dropdown-menu-right dropdown-caret dropdown-animated dd-appear-center dd-slide-none-md radius-1 brc-secondary-l1">
                            <div class="dropdown-inner">
                                <a class="dropdown-item btn btn-light-grey btn-h-lighter-default btn-a-lighter-primary btn-bgc-tp px-3" href="#" title="Some action" data-toggle="tooltip">
                                    <i class="fa fa-cog mr-1 text-blue"></i>
                                    <span class="d-md-none">Some action</span>
                                </a>

                                <a class="dropdown-item btn btn-light-grey btn-h-lighter-default btn-a-lighter-primary btn-bgc-tp px-3" href="#" title="Another action" data-toggle="tooltip">
                                    <i class="fas fa-tools text-orange mr-1"></i>
                                    <span class="d-md-none">Another action</span>
                                </a>
                            </div>
                        </div>
                    </div>

                </div>
            </div>



            <div class="col-12 col-sm-6 col-lg-3 px-2 mb-2 mb-lg-0">
                <div class="bcard h-100 d-flex align-items-center p-3">

                    <div>
                        <span class="d-inline-block bgc-primary p-3 radius-round text-center border-4 brc-primary-l2">
                            <i class="fas fa-chart-line text-white text-170 w-4 h-4"></i>
                        </span>
                    </div>

                    <div class="ml-3 flex-grow-1">
                        <div>
                            <span class="text-dark-tp3 text-180">520k</span>

                            <span class="text-blue-m1 text-600 text-90 ml-2 text-nowrap">
                                3%
                                <i class="fa fa-arrow-up"></i>
                            </span>
                        </div>
                        <div class="text-dark-tp4 text-110">total tasks</div>
                    </div>

                    <div class="mr-auto">
                        <canvas id="infobox-chart1" style="width: 70px;"></canvas>
                    </div>

                    <div class="position-tr m-1">
                        <!-- the dropdown used in some boxes (cards) -->
                        <div class="dropdown dd-backdrop dd-backdrop-none-md">
                            <button type="button" class="btn btn-sm btn-text-pale btn-brc-tp btn-outline-lightgrey btn-h-light-default btn-a-light-default dropdown-toggle" data-toggle="dropdown" data-display="static" aria-haspopup="true" aria-expanded="false">
                                <i class="fa fa-ellipsis-h"></i>
                            </button>

                            <div class="dropdown-menu p-3px mw-auto shadow-sm dropdown-menu-right dropdown-caret dropdown-animated dd-appear-center dd-slide-none-md radius-1 brc-secondary-l1">
                                <div class="dropdown-inner">
                                    <a class="dropdown-item btn btn-light-grey btn-h-lighter-default btn-a-lighter-primary btn-bgc-tp px-3" href="#">
                                        <i class="fa fa-cog text-blue mr-1"></i>
                                        Some action
                                    </a>

                                    <a class="dropdown-item btn btn-light-grey btn-h-lighter-default btn-a-lighter-primary btn-bgc-tp px-3" href="#">
                                        <i class="fas fa-tools text-blue mr-1"></i>
                                        Another action
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>


            <div class="col-12 col-sm-6 col-lg-3 px-2 mb-2 mb-lg-0">
                <div class="bcard h-100 d-flex align-items-center p-3">

                    <div class="text-center pos-rel ml-1">
                        <canvas id="task-progress-piechart" style="height: 75px; width: 75px; max-height: 75px; max-width: 75px;"></canvas>

                        <span class="position-center text-dark-tp3 text-600">71%</span>
                    </div>

                    <div class="ml-3 flex-grow-1">
                        <div>
                            <span class="text-dark-tp3 text-125">Task Progress</span>
                        </div>
                        <div class="text-dark-tp4 text-110">3 remaining</div>
                    </div>

                    <div class="position-tr m-1">
                        <!-- the dropdown used in some boxes (cards) -->
                        <div class="dropdown dd-backdrop dd-backdrop-none-md">
                            <button type="button" class="btn btn-sm btn-text-pale btn-brc-tp btn-outline-lightgrey btn-h-light-default btn-a-light-default dropdown-toggle" data-toggle="dropdown" data-display="static" aria-haspopup="true" aria-expanded="false">
                                <i class="fa fa-ellipsis-h"></i>
                            </button>

                            <div class="dropdown-menu p-3px mw-auto shadow-sm dropdown-menu-right dropdown-caret dropdown-animated dd-appear-center dd-slide-none-md radius-1 brc-secondary-l1">
                                <div class="dropdown-inner">
                                    <a class="dropdown-item btn btn-light-grey btn-h-lighter-default btn-a-lighter-primary btn-bgc-tp px-3" href="#">
                                        <i class="fa fa-cog text-blue mr-1"></i>
                                        Some action
                                    </a>

                                    <a class="dropdown-item btn btn-light-grey btn-h-lighter-default btn-a-lighter-primary btn-bgc-tp px-3" href="#">
                                        <i class="fas fa-tools text-blue mr-1"></i>
                                        Another action
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    }



    <div class="row">
        <div class="col-lg-12 pt-2">

            @*<div class="page-header border-0 mb-3">
                    <h1 class="page-title text-primary-d2 text-150">
                        Order(s)
                    </h1>
                </div>*@


            <!-- message to be displayed on touch devices -->
            <div id="alert-1" class="d-none alert bgc-white border-none border-l-4 brc-purple-m1 shadow-sm" role="alert">
                Touch a date slot and hold down to add a new event
            </div>



            <div class="row">
                <div class="col-12 col-md-9" id='calendar-container'>
                    <div class="card bcard">
                        <div class="card-body p-lg-4">
                            <div id='calendar' class="text-blue-d1"></div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-3 mt-3 mt-md-0" id='external-events'>
                    <div class="bgc-white shadow-sm p-35 radius-1">
                        <p class="text-120 text-primary-d2">
                            Order (Without Ship Date)
                        </p>

                        <p id="alert-2" class="alert bgc-grey-l4 border-none border-l-4 brc-purple-m1">
                            Drag and drop the following order to calender for setup ship date
                        </p>

                        <div id='external-events-listing'>
                            @foreach (var item in Model.OrderList.Where(w => w.ShipStartDate == null))
                            {

                                <div style="cursor:pointer" onclick="showOrderDetail(@item.OrderId)"
                                     class="fc-event badge bgc-blue-d1 text-white border-0 py-2 text-90 mb-1 radius-2px"
                                     data-class="bgc-blue-d1 text-white text-95">
                                    Order #<span>@item.OrderId</span> <br />
                                    @item.EmployeeName

                                </div>

                            }

                        </div>


                    </div>

                </div>



            </div>

            <div class="row" style="margin-top:15px">
                <div class="col-12 col-lg-12">
                    <div class="bcard card h-100">


                        <div class="card-body p-0">
                            <div class="table-responsive-md">
                                <table class="table table-border-x brc-secondary-l3 mb-0">
                                    <thead class="sticky-nav text-secondary-m1 text-uppercase text-85">
                                        <tr class="text-80 text-white bgc-blue">
                                            <th class="pl-2 pl-lg-4">ID</th>
                                            <th>Order Date</th>
                                            <th>Customer</th>
                                            <th>Ship Date</th>
                                            <th> Amount($)</th>
                                            <th>Assigned To</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        @foreach (var item in Model.OrderList)
                                        {
                                            <tr class="bgc-h-secondary-l4">
                                                <td class="pl-2 pl-lg-4">
                                                    <a href="#" class="text-95 text-primary text-600">
                                                        #@item.OrderId
                                                    </a>
                                                </td>

                                                <td class="text-dark-m2 text-85">@item.OrderDate.ToString("MM/dd/yyyy")</td>

                                                <td class=" text-dark-m2 text-85"> @item.CustomerName</td>

                                                <td class=" text-dark-m2 text-85"> @item.ShipStartDate?.ToString("MM/dd/yyyy HH:MM")</td>

                                                <td class="font-bolder text-75 text-dark-m2 pr-2 pr-lg-3">
                                                    @item.TotalAmount
                                                </td>

                                                <td class="text-secondary-d3 text-95">
                                                    @item.EmployeeName

                                                </td>
                                                <td class="text-secondary-d3 text-95">
                                                    @item.Status

                                                </td>
                                            </tr>
                                        }
                                        @if (Model.OrderList.Count() == 0)
                                        {
                                            <tr class="bgc-h-secondary-l4">
                                                <td class="pl-2 pl-lg-4" colspan="7">
                                                    No Order Assigned
                                                </td>
                                            </tr>

                                        }


                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>


        </div>
    </div>

</div>


@section Styles {
    <environment names="Development,Staging,Production">
        <link rel="stylesheet" href="~/lib/fullcalendar/main.css" />
    </environment>
    <style>
        .topBar {
            display: block !important;
        }

        #calendar .extEvt {
            display: none !important;
        }
    </style>
}

@section scripts {
    <environment names="Development,Staging,Production">
        <script src="~/lib/moment/moment.js"></script>
        <script src="~/lib/fullcalendar/main.js"></script>
        <script src="~/js/Chart.js"></script>
        <script src="~/pages/dashboard/page-script.js"></script>
        <script src="~/pages/calendar/@@page-script.js"></script>
    </environment>
    <script type="text/javascript">
        window.orderList = '@Json.Serialize(Model.OrderList)';
        window.employeeList = '@Json.Serialize(Model.EmployeeList)';
        window.orderList = JSON.parse(window.orderList);
        window.employeeList = JSON.parse(window.employeeList);

        function getEvents() {
            var arr = [];
            for (var i = 0; i < window.orderList.length; i++) {
                if (window.orderList[i]['ShipStartDate'] != null) {

                for (var i = 0; i <  window.orderList.length; i++) {
                    arr.push({
                        id: window.orderList[i]['OrderId'],
                        resourceId: window.orderList[i]['EmployeeId'],
                        title: window.orderList[i]['CustomerName'] + '<br/>' + window.orderList[i]['EmployeeName'],
                        start: new Date(window.orderList[i]['ShipStartDate']),
                        end: window.orderList[i]['ShipEndDate'] == null ? null : new Date(window.orderList[i]['ShipEndDate']),
                        allDay: false,
                        extendedProps: window.orderList[i],
                        className: 'bgc-info text-white text-75'
                    });
            }
            }
            }
            window.calenderEvents = arr;
            return arr;

        }

        function getResource() {

            var arr = [];
             var filterArray = [];
            for (var i = 0; i < window.orderList.length; i++) {
                if (window.orderList[i]['ShipStartDate'] != null) {
                    arr.push(window.orderList[i]['EmployeeId']);
                    filterArray.push(window.orderList[i]);
                }
            }

            arr = $.unique(arr);
            var resourceArray = [];
            for (var i = 0; i < arr.length; i++) {
                var empName = getEmloyeeName(filterArray, arr[i]);
                resourceArray.push({
                    id: arr[i],
                    title: arr[i].toString()=="0"? "Not Assigned":empName
                });

            }
            console.log(resourceArray);
            return resourceArray;

        }

        function getEmloyeeName(filterArray,id) {
            var name = "";
            for (var i = 0; i < filterArray.length; i++) {
                if (filterArray[i]["EmployeeId"] == id) {
                    name = filterArray[i]["EmployeeName"];
                    break;
                }

            }
            return name;
        }

        function updateOrderDate(orderId,start,end,callback) {
            var data = {
                'orderId': orderId, 'start': (start==null ? null : new moment(start).format("MM/DD/YYYY HH:mm")) ,
                'end': (end==null ? null : new moment(end).format("MM/DD/YYYY HH:mm"))
            };
            console.log(data);
            $.ajax({
                url: "/Order/UpdateOrderDate",
                type: "POST",
                dataType: "json",
                data: data,
                success: function (data) {
                     callback(data)
                },
                error: function (data) {
                    debugger;

                }
            })

        }


        function updateOrder(orderId) {

            var employeeId = $("#EmployeeId").val();

            if (!employeeId) {
                alert("Please select assignee");
                return;
            }


              var data = {
                  'orderId': orderId,
                   'employeeId': employeeId
                };
            console.log(data);
            $.ajax({
                url: "/Order/UpdateOrderAssignee",
                type: "POST",
                dataType: "json",
                data: data,
                success: function (data) {
                    $("#btnSumbit").trigger('click');
                }
            })
        }

        function showOrderDetail(id) {
             $.ajax({
                 url: "/Home/GetOrderPopup/" + id,
                type: "POST",
                contentType: "application/json; charset=utf-8",
                dataType: "html",
                success: function (response) {
                    var modal = response;
                    modal = $(modal).appendTo('body');
                    modal.find('form').on('submit', function (ev) {
                        ev.preventDefault();
                        //info.event.setProp('title', info.event._def.extendedProps.CustomerName + '<br />' + $("#EmployeeId option:selected").text());
                        window.location.reload();
                        modal.modal("hide");
                    });
                    modal.find('button[data-action=delete]').on('click', function () {
                        modal.modal("hide");
                    });
                    modal.modal('show').on('hidden.bs.modal', function () {
                        modal.remove();
                    });
                }
            });
        }

    </script>
}